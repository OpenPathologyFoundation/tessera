
> wbc-delta-sigma@1.0.0 test
> node --test 'tests/*.test.js'

▶ Calculation Engine — Percentage Computation (SYS-040 to SYS-045)
  ✔ VV-CALC-001: All zeros returns 0.00 for every cell (SYS-042, HA-021) (0.653458ms)
  ✔ VV-CALC-002: Single cell counted = 100.00% (SYS-040) (0.092833ms)
  ✔ VV-CALC-003: Two equal cells = 50.00% each (SYS-040) (0.070625ms)
  ✔ VV-CALC-004: Nine equal cells = 11.11% each (SYS-040) (0.077667ms)
  ✔ VV-CALC-005: One dominant cell type (SYS-040) (0.070292ms)
  ✔ VV-CALC-006: All ones (total=9), each = 11.11% (SYS-040) (0.056125ms)
  ✔ VV-CALC-007: Standard BM differential (100 cells) — exact percentages (SYS-040) (0.068ms)
  ✔ VV-CALC-008: Abnormal BM differential — leukemia pattern (SYS-040) (0.065042ms)
  ✔ VV-CALC-009: Small count (10 cells) — correct percentages (SYS-040) (0.071167ms)
  ✔ VV-CALC-010: Large count (500 cells) — correct percentages (SYS-P04) (0.148708ms)
  ✔ VV-CALC-011: Repeating thirds — sum within tolerance (SYS-044) (0.081042ms)
  ✔ VV-CALC-012: Six equal cells — sum within tolerance (SYS-044) (0.066584ms)
  ✔ VV-CALC-013: Near-even distribution (total=10) (SYS-040) (0.043583ms)
  ✔ VV-CALC-014: Maximum capacity 9999 cells — no degradation (SYS-P04) (0.065ms)
  ✔ VV-CALC-015: Standard PB differential (100 cells) (SYS-040) (0.064417ms)
  ✔ SYS-041: All percentages have exactly 2 decimal places (0.049167ms)
  ✔ SYS-044: Percentage sum within ±0.10 of 100% for 20 random distributions (0.113375ms)
✔ Calculation Engine — Percentage Computation (SYS-040 to SYS-045) (3.227709ms)
▶ Calculation Engine — Increment/Decrement (SYS-031 to SYS-033)
  ✔ VV-INC-001: Increment from zero gives 1 (0.079583ms)
  ✔ VV-INC-002: Increment from 5 gives 6 (0.027209ms)
  ✔ VV-INC-003: Decrement from 5 gives 4 (0.036333ms)
  ✔ VV-INC-004: Decrement from 1 gives 0 (0.02725ms)
  ✔ VV-INC-005: Decrement from 0 stays at 0 — NEVER negative (SYS-033, HA-013) (0.036959ms)
  ✔ VV-INC-006: Decrement the only cell returns to zero total (0.028042ms)
  ✔ VV-INC-007: Increment after decrement to zero works (0.027459ms)
  ✔ VV-INC-008: 20 rapid increments yield 20 (0.030958ms)
  ✔ Increment followed by decrement returns to original value (0.035209ms)
  ✔ 1000 increments yield exactly 1000 (0.059666ms)
✔ Calculation Engine — Increment/Decrement (SYS-031 to SYS-033) (0.492416ms)
▶ Calculation Engine — Output Template JSON (SYS-061)
  ✔ VV-TPL: Output JSON contains case number, total, and all cell percentages (0.115709ms)
  ✔ VV-TPL: Output percentages are rounded integers (0.046042ms)
  ✔ VV-TPL: Zero total produces all zeros in output (0.036ms)
✔ Calculation Engine — Output Template JSON (SYS-061) (0.250166ms)
▶ Configuration — File Loading (SYS-100, SYS-101)
  ✔ templates.json exists and is readable (0.508209ms)
  ✔ templates.json contains valid JSON (0.174792ms)
  ✔ Configuration is an array with at least 1 specimen type (SYS-102) (0.052833ms)
✔ Configuration — File Loading (SYS-100, SYS-101) (1.381667ms)
▶ Configuration — Schema Validation (SYS-102, SYS-103)
  ✔ Each entry has required fields: specimenType, outCodes, templates (0.106416ms)
  ✔ specimenType values are unique (no duplicates) (0.076334ms)
  ✔ Bone Marrow (bm) specimen type is configured (0.052875ms)
  ✔ Peripheral Blood (pb) specimen type is configured (0.052209ms)
✔ Configuration — Schema Validation (SYS-102, SYS-103) (0.412708ms)
▶ Configuration — outCodes Validation (SYS-038, SYS-039, HA-062)
  ✔ outCodes keys are single uppercase letters (0.148375ms)
  ✔ outCodes values are non-empty strings (0.094208ms)
  ✔ No duplicate keys within a specimen type (HA-062) (0.106083ms)
  ✔ No duplicate cell type values within a specimen type (0.062917ms)
  ✔ BM has exactly 9 cell types mapped to correct keys (SYS-014, SYS-038) (0.054167ms)
  ✔ PB has exactly 9 cell types mapped to correct keys (SYS-015, SYS-039) (0.042959ms)
✔ Configuration — outCodes Validation (SYS-038, SYS-039, HA-062) (1.384875ms)
▶ Configuration — Template Validation (SYS-060, HA-050)
  ✔ Each template has tplCode, tplName, and outSentence (0.078458ms)
  ✔ Every template contains {{total}} placeholder (0.041625ms)
  ✔ Every template contains all cell type placeholders for its specimen type (0.079708ms)
  ✔ BM has 3 templates (Yale SOM, Precipio DX, MGH) (0.048666ms)
  ✔ PB has 1 template (MGH) (0.034542ms)
✔ Configuration — Template Validation (SYS-060, HA-050) (0.354333ms)
▶ Configuration — Minimum Cell Count (SYS-052, SYS-103)
  ✔ BM minCellCount is 200 (0.04425ms)
  ✔ PB minCellCount is 100 (0.028708ms)
  ✔ minCellCount values are positive integers (0.036167ms)
✔ Configuration — Minimum Cell Count (SYS-052, SYS-103) (0.148583ms)
▶ Configuration — Template Rendering (VV-TPL-001 to VV-TPL-004)
  ✔ VV-TPL-001: Yale SOM template renders with no unresolved placeholders (0.12325ms)
  ✔ VV-TPL-002: Precipio DX template renders with no unresolved placeholders (0.060958ms)
  ✔ VV-TPL-003: MGH BM template renders with no unresolved placeholders (0.063958ms)
  ✔ VV-TPL-004: MGH PB template renders with no unresolved placeholders (0.063917ms)
✔ Configuration — Template Rendering (VV-TPL-001 to VV-TPL-004) (0.359292ms)
▶ HTML Structure — File Integrity
  ✔ counter.html exists and is readable (0.619041ms)
  ✔ HTML has correct doctype and lang attribute (0.060958ms)
  ✔ HTML includes Tailwind CSS (0.050584ms)
  ✔ HTML includes the application script mdc-app.js (0.053625ms)
  ✔ HTML does not include old Backbone/jQuery dependencies (0.075667ms)
✔ HTML Structure — File Integrity (1.5535ms)
▶ HTML Structure — Case Identification Elements (SYS-001 to SYS-004)
  ✔ SYS-001: Case number input field exists with id="caseNumber" (0.592375ms)
  ✔ Case number input has maxlength="30" (SYS-002) (0.177084ms)
  ✔ Case number input has autocomplete="off" (prevents browser autofill) (0.0795ms)
  ✔ SYS-004: Case badge display element exists (0.069667ms)
✔ HTML Structure — Case Identification Elements (SYS-001 to SYS-004) (1.054208ms)
▶ HTML Structure — Specimen Type Selection (SYS-010)
  ✔ Specimen type select element exists with id="specimenType" (0.110375ms)
  ✔ Bone Marrow option with value="bm" exists (0.083542ms)
  ✔ Peripheral Blood option with value="pb" exists (0.071583ms)
✔ HTML Structure — Specimen Type Selection (SYS-010) (0.347333ms)
▶ HTML Structure — Control Buttons (SYS-050, SYS-080)
  ✔ Start Count button exists and is initially disabled (SYS-003) (0.078625ms)
  ✔ Count Done button exists (SYS-050) (0.030875ms)
  ✔ Reset button exists (SYS-080) (0.044667ms)
  ✔ Copy to Clipboard button exists (SYS-064) (0.037333ms)
  ✔ New Case button exists (0.031458ms)
✔ HTML Structure — Control Buttons (SYS-050, SYS-080) (0.294833ms)
▶ HTML Structure — Three-Phase Layout
  ✔ Phase 1: Case entry section exists (0.042208ms)
  ✔ Phase 2: Counting section exists (hidden initially) (0.069708ms)
  ✔ Phase 3: Results section exists (hidden initially) (0.068916ms)
  ✔ Counter table rendering area exists (0.02725ms)
✔ HTML Structure — Three-Phase Layout (0.2585ms)
▶ HTML Structure — Morphology Comments (SYS-070)
  ✔ Morphology comments textarea exists with id="morphComments" (0.052375ms)
  ✔ Comments textarea has maxlength="500" (SYS-071) (0.032333ms)
  ✔ Character counter exists (0.029792ms)
✔ HTML Structure — Morphology Comments (SYS-070) (0.151833ms)
▶ HTML Structure — Output Area (SYS-062)
  ✔ Tab navigation area exists (0.038917ms)
  ✔ Tab panels area exists (0.027375ms)
  ✔ Results summary area exists (0.029791ms)
✔ HTML Structure — Output Area (SYS-062) (0.13475ms)
▶ HTML Structure — Session History (SYS-092, SYS-094)
  ✔ Session history section exists (0.060125ms)
  ✔ History list container exists (0.040334ms)
  ✔ History count badge exists (0.028417ms)
  ✔ Export session buttons exist (0.03675ms)
  ✔ Temporary data notice is present (SYS-094) (0.055834ms)
✔ HTML Structure — Session History (SYS-092, SYS-094) (0.271209ms)
▶ HTML Structure — Modal Dialogs (SYS-007, SYS-053, SYS-081)
  ✔ Confirmation modal overlay exists (0.042625ms)
  ✔ Modal has title, message, confirm, and cancel elements (0.058541ms)
  ✔ History detail modal exists (0.049708ms)
✔ HTML Structure — Modal Dialogs (SYS-007, SYS-053, SYS-081) (0.188584ms)
▶ HTML Structure — Accessibility & Usability
  ✔ Labels are associated with inputs via "for" attribute (0.049542ms)
  ✔ Status indicator elements exist (0.028875ms)
  ✔ Theme toggle button exists (0.046833ms)
  ✔ Keyboard hint text is present for users (0.031667ms)
✔ HTML Structure — Accessibility & Usability (0.207459ms)
▶ JavaScript — File Integrity
  ✔ mdc-app.js exists and is readable (0.73125ms)
  ✔ mdc-app.js has valid syntax (no parse errors) (0.871875ms)
  ✔ Uses strict mode (0.065125ms)
  ✔ Wraps in IIFE to avoid global namespace pollution (0.070291ms)
✔ JavaScript — File Integrity (2.422708ms)
▶ JavaScript — State Management
  ✔ State object initializes phase to "case-entry" (0.0745ms)
  ✔ State tracks isCountingActive flag (0.042459ms)
  ✔ State tracks commentFieldFocused flag (SYS-073) (0.041416ms)
✔ JavaScript — State Management (0.262166ms)
▶ JavaScript — Keyboard Handler Safety (SYS-030 to SYS-036)
  ✔ Has keydown event handler function (0.103083ms)
  ✔ Checks isCountingActive before processing keypresses (HA-015) (0.060333ms)
  ✔ Ignores keypresses when comment field is focused (SYS-073) (0.077125ms)
  ✔ Ignores Ctrl, Alt, Meta modifier keys (SYS-036) (0.061541ms)
  ✔ Checks shiftKey for decrement operation (SYS-032) (0.039917ms)
  ✔ Prevents event default on mapped keys (0.032916ms)
  ✔ Detaches keydown listener on count completion (SYS-054) (0.033292ms)
✔ JavaScript — Keyboard Handler Safety (SYS-030 to SYS-036) (0.552375ms)
▶ JavaScript — Decrement Safety (SYS-033, HA-013)
  ✔ Has decrement guard: count > 0 check (0.059666ms)
  ✔ Decrement uses -- operator (subtracts exactly 1) (0.034667ms)
  ✔ Increment uses ++ operator (adds exactly 1) (0.02975ms)
✔ JavaScript — Decrement Safety (SYS-033, HA-013) (0.176583ms)
▶ JavaScript — Division by Zero Guard (SYS-042, HA-021)
  ✔ Checks total === 0 before percentage calculation (0.048917ms)
  ✔ Returns 0.00 when total is 0 (not NaN) (0.079083ms)
✔ JavaScript — Division by Zero Guard (SYS-042, HA-021) (0.162917ms)
▶ JavaScript — Minimum Cell Count Enforcement (SYS-052, SYS-053, HA-030)
  ✔ References minCellCount from config (0.0585ms)
  ✔ Compares total against minimum before completion (0.037166ms)
  ✔ Shows modal/dialog for low count warning (0.029041ms)
✔ JavaScript — Minimum Cell Count Enforcement (SYS-052, SYS-053, HA-030) (0.163125ms)
▶ JavaScript — Reset Confirmation (SYS-081, HA-040)
  ✔ Shows confirmation before reset when data exists (0.033375ms)
  ✔ Checks if total > 0 before showing confirmation (0.0335ms)
✔ JavaScript — Reset Confirmation (SYS-081, HA-040) (0.103333ms)
▶ JavaScript — Copy to Clipboard (SYS-065, SYS-066)
  ✔ Uses navigator.clipboard API (0.03675ms)
  ✔ Has fallback for clipboard API failure (0.031167ms)
  ✔ Shows "Copied!" confirmation text (SYS-066) (0.033041ms)
✔ JavaScript — Copy to Clipboard (SYS-065, SYS-066) (0.138042ms)
▶ JavaScript — Clipboard Safety
  ✔ Clears clipboard on new case start (0.460125ms)
✔ JavaScript — Clipboard Safety (0.484375ms)
▶ JavaScript — Session History (SYS-090, SYS-095)
  ✔ Uses sessionStorage (not localStorage) for history (SYS-095) (0.078792ms)
  ✔ Saves to sessionStorage with a key prefix (0.027541ms)
  ✔ Has try/catch around sessionStorage operations (graceful degradation) (0.026542ms)
✔ JavaScript — Session History (SYS-090, SYS-095) (0.173708ms)
▶ JavaScript — Session Export
  ✔ Defines export handlers for CSV and JSON (0.0455ms)
  ✔ Creates downloadable files using Blob and object URLs (0.063167ms)
✔ JavaScript — Session Export (0.151041ms)
▶ JavaScript — Theme Toggle
  ✔ Defines theme toggle controls and storage key (0.106334ms)
  ✔ Applies data-theme attribute for light/dark modes (0.030042ms)
✔ JavaScript — Theme Toggle (0.166958ms)
▶ JavaScript — Security (SYS-S04)
  ✔ Escapes HTML in user-provided content (XSS prevention) (0.048541ms)
  ✔ Has HTML escape function defined (0.77125ms)
✔ JavaScript — Security (SYS-S04) (0.871666ms)
▶ JavaScript — Configuration Loading (SYS-100, SYS-101)
  ✔ Fetches templates.json (0.052333ms)
  ✔ Handles fetch failure with error display (SYS-101) (0.026958ms)
  ✔ Applies default minCellCount when missing from config (SYS-103) (0.023292ms)
✔ JavaScript — Configuration Loading (SYS-100, SYS-101) (0.150208ms)
▶ JavaScript — Flash Feedback (SYS-037)
  ✔ Has flash/animation function for keypress feedback (0.032125ms)
  ✔ Distinguishes increment and decrement visually (0.035709ms)
✔ JavaScript — Flash Feedback (SYS-037) (0.099958ms)
▶ End-to-End — VV-E2E-001: Standard BM 100-Cell Differential
  ✔ Checkpoint 1: All counts correct (0.736541ms)
  ✔ Checkpoint 1: Total = 100 (0.076041ms)
  ✔ Checkpoint 1: Percentages are correct (0.0665ms)
  ✔ Checkpoint 1: Percentage sum = 100.00 (0.059958ms)
  ✔ Checkpoint 2: Yale SOM output contains total (0.080125ms)
  ✔ Checkpoint 2: Yale SOM output contains cell percentages (0.053083ms)
  ✔ Checkpoint 2: Precipio DX output is populated (0.044417ms)
  ✔ Checkpoint 2: MGH output is populated (0.052541ms)
  ✔ Checkpoint 2: No unresolved placeholders in any output (0.179167ms)
✔ End-to-End — VV-E2E-001: Standard BM 100-Cell Differential (2.154833ms)
▶ End-to-End — Undo/Correction Flow
  ✔ Shift+key correctly decrements and recalculates (0.20575ms)
  ✔ Cannot undo below zero (0.513958ms)
  ✔ Undo then re-count returns to correct state (0.129125ms)
✔ End-to-End — Undo/Correction Flow (0.952375ms)
▶ End-to-End — Peripheral Blood Workflow
  ✔ PB differential produces correct output (0.14875ms)
✔ End-to-End — Peripheral Blood Workflow (0.184417ms)
▶ End-to-End — Unmapped Key Handling (SYS-035)
  ✔ Unmapped keys are silently ignored (0.083667ms)
✔ End-to-End — Unmapped Key Handling (SYS-035) (0.113125ms)
▶ End-to-End — Edge Cases
  ✔ Single cell count produces 100% (0.074041ms)
  ✔ Large count (500 cells) produces correct percentages (0.166ms)
  ✔ All zeros with undo attempts produces safe output (0.068917ms)
✔ End-to-End — Edge Cases (0.361042ms)
ℹ tests 153
ℹ suites 39
ℹ pass 153
ℹ fail 0
ℹ cancelled 0
ℹ skipped 0
ℹ todo 0
ℹ duration_ms 92.249375
